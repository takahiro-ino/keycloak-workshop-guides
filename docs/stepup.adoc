[#intro]
この章では、QuakrusとRed Hat SSOを用いてステップアップ認証を実装してみます。
ステップアップ認証は、WebアプリやAPIで、参照の場合はログイン認証のみで、更新の場合はログイン認証+OTPやWebAuthを使った生体認証などができるようになります。
インターネットバンキングで、振り込みする際に追加で認証情報を求められることがあると思いますが、それがまさしくステップアップ認証になります。

ステップアップ認証は、OIDCのACR(Authentication Context Class Reference)を利用しています。
アプリ側で実装する場合は、アプリ側で該当するOIDCのクレームで必要とする値がない場合は、認証リダイレクトにそのクレーム頂戴というクエリを追加する必要があります。
通常は、微妙に実装するのが手間になりますが、QuarkusにはOIDCの認証リダイレクトにクエリパラメータとして追加できるプロパティがあるため、その機能を利用して、ソースコードを変更せずに実現します。

[#config-OTP]
=== ステップアップ認証のためのワンタイムパスワード（OTP）の設定
Red Hat SSO では、ワンタイムパスワード（OTP）が利用できます。
具体的には、スマートフォンアプリのFreeOTPとGoogle Authenticatorが利用可能です。
以降の手順では、スマートフォンに、FreeOTPとGoogle Authenticatorが必要なため、お手持ちのスマートフォンにいずれかをインストールしておく必要があります。

ワンタイムパスワード（OTP）の設定を実施します。
Red Hat SSOのアカウント管理画面から、 `Personal Info` をクリックしてください。

なお、Red Hat SSOのアカウント管理画面は、以下のURLになります。

* アカウント管理画面: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/realms/demojs/account


image::sso_otp1.png[otp1]

Personal Info画面の左ペインから、 `Account Security` をクリックし、さらに `Signing In` をクリックし、
Signing In画面の `Set up Autehnticator Application` をクリックします。

image::sso_otp2.png[otp2]

[NOTE]
====
下記のページが表示された場合は、さきほど入力したユーザ名とパスワードを入力し、`Sing in` をクリックしてください。

image::sso_otp2-1.png[otp2-1]
====

以下のようにQRコードが画面に表示されます。お手持ちのスマートフォンのFreeOTPとGoogle Authenticatorから、QRコードをスキャンします。

image::sso_otp3.png[otp3]

以下は、FreeOTPでの操作となります。
FreeOTPを起動し、QRスキャンボタンを押します。

image::free_otp1.png[free_otp1, 400]

スマートフォンでRH-SSOの画面のQRコードをスキャンし、いくつかボタンを押すと、FreeOTPにレルム名(demojs)で登録されます。

image::free_otp2.png[free_otp2, 400]

スマートフォンのFreeOTPに登録されたレルム名(demojs)をクリックすると、ワンタイムパスワードが表示されます。

image::free_otp3.png[free_otp3, 400]

スマートフォンのFreeOTPで表示されたワンタイムパスワードとデバイス名(何でも良い)をRH-SSOの画面に入力し、 `Submit` をクリックし、登録します。

image::sso_otp4.png[otp4]

登録が完了すると、Personal Info画面でさきほど入力したデバイス名で、登録されていることがわかります。

image::sso_otp5.png[otp5]

さて、これで Red Hat SSO サーバーのユーザ登録とOTPの設定ができました。

[#config-sso]
=== ステップアップ認証のための認証フローの設定その１
Red Hat SSOでは、認証フローを `Authentication` でカスタマイズができます。

ステップアップ認証用の認証フローを作っていきます。(画面操作がかなりあります)

SSOの管理コンソールのAuthenticationの画面に移動します。下記のリンクからダイレクトに移動できます。

* SSOの管理コンソール: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/admin/master/console/#/realms/demojs/authentication/flows

`New` をクリックします。

image::sso_steup01.png[sso_steup01]

Create Top Level Form画面のAliasに `Stepup` と入力し、 `Save` をクリックします。

image::sso_steup02.png[sso_steup02]


自動でAuthenticationの画面に戻ります。Stepupフローの設定画面になっているので、 その画面から `Add execution` をクリックします。

image::sso_steup03.png[sso_steup03]

Providerのプルダウンリストから  `Cookie` を選択します。

image::sso_steup04.png[sso_steup04]

選択後、 `Save` をクリックします

image::sso_steup05.png[sso_steup05]

Authenticationの画面に、Cookieが追加されました。 Requirementを `Alternative` に変更します。

image::sso_steup06.png[sso_steup06]

1つ目の認証レベル(ユーザ名とパスワードのみ)のフローを設定します。

画面から `Add flow` をクリックします。

image::sso_steup07.png[sso_steup07]

Create Execution Flow画面のAliasに `1st Condition Flow` と入力し、 `Save` をクリックします。

image::sso_steup08.png[sso_steup08]

Authenticationの画面に、 1st Condition Flow が追加されました。 Requirementを `Conditional` に変更します。

image::sso_steup09.png[sso_steup09]

1st Condition Flow の `Actions` をクリックし、 `Add execution` をクリックします。

image::sso_steup10.png[sso_steup10]

Create Authenticator Executionの画面で、 Providerのプルダウンリストから  `Conditional - Level Of Authentication` を選択します。

image::sso_steup11.png[sso_steup11]

選択後、 `Save` をクリックします

image::sso_steup12.png[sso_steup12]

Authenticationの画面に、Conditional - Level Of Authenticationが追加されました。 Requirementを `Required` に変更し、Requirementを必須にします。

image::sso_steup13.png[sso_steup13]

Conditional - Level Of Authentication の `Actions` をクリックし、 `Config` をクリックします。

image::sso_steup14.png[sso_steup14]

Create authenticator config画面で、以下の項目を入力し、 `save` をクリックします。

* Alias: `Level 1`
* Level of Authentication (LoA) : 1

image::sso_steup15.png[sso_steup15]

save が完了したら、 Stepupをクリックし、画面を戻します。

image::sso_steup16.png[sso_steup16]

1st Condition Flow の `Actions` をクリックし、 `Add execution` をクリックします。

image::sso_steup17.png[sso_steup17]

Create Authenticator Executionの画面で、 Providerのプルダウンリストから  `Usernmae Password Form` を選択します。

image::sso_steup18.png[sso_steup18]

選択後、 `Save` をクリックします

image::sso_steup19.png[sso_steup19]

Authenticationの画面に、Usernmae Password Formが追加されました。 

これで1つ目の認証レベル(ユーザ名とパスワードのみ)のフローが設定されました。

image::sso_steup20.png[sso_steup20]

=== ステップアップ認証のための認証フローの設定その2

2つ目の認証レベル(OTPでの認証)のフローを設定します。

画面から `Add flow` をクリックします。

image::sso_stepup2-01.png[sso_stepup2-01]

Create Execution Flow画面のAliasに `2nd Condition Flow` と入力し、 `Save` をクリックします。

image::sso_stepup2-02.png[sso_stepup2-02]

Authenticationの画面に、 2nd Condition Flow が追加されました。 Requirementを `Conditional` に変更します。

image::sso_stepup2-03.png[sso_stepup2-03]

2nd Condition Flow の `Actions` をクリックし、 `Add execution` をクリックします。

image::sso_stepup2-04.png[sso_stepup2-04]

Create Authenticator Executionの画面で、 Providerのプルダウンリストから  `Conditional - Level Of Authentication` を選択します。

image::sso_steup11.png[sso_steup11]

選択後、 `Save` をクリックします

image::sso_steup12.png[sso_steup12]

Authenticationの画面に、Conditional - Level Of Authenticationが追加されました。 Requirementを `Required` に変更し、Requirementを必須にします。

image::sso_stepup2-05.png[sso_stepup2-05]

Conditional - Level Of Authentication の `Actions` をクリックし、 `Config` をクリックします。

image::sso_stepup2-06.png[sso_stepup2-06]

Create authenticator config画面で、以下の項目を入力し、 `save` をクリックします。

* Alias: `Level 2`
* Level of Authentication (LoA) : 2

image::sso_stepup2-07.png[sso_stepup2-07]

save が完了したら、 Stepupをクリックし、画面を戻します。

image::sso_stepup2-08.png[sso_stepup2-08]

2nd Condition Flow の `Actions` をクリックし、 `Add execution` をクリックします。

image::sso_stepup2-09.png[sso_stepup2-09]

Create Authenticator Executionの画面で、 Providerのプルダウンリストから  `OTP Form` を選択します。

image::sso_stepup2-10.png[sso_stepup2-10]

選択後、 `Save` をクリックします

image::sso_stepup2-11.png[sso_stepup2-11]

Authenticationの画面に、OTPが追加されました。  Requirementを `Required` に変更し、Requirementを必須にします。

image::sso_stepup2-12.png[sso_stepup2-12]

これで2つ目の認証レベル(OTPでの認証)のフローが設定されました。

=== ステップアップ認証のための認証フローの設定その3
最後に、バインディングを変更します。
バインディングとは、各処理(ブラウザでのユーザログインやユーザ登録等)で、どの認証フローを利用するかを関連付けするものです。
ここでは、さきほど作成したStepupの認証フローをブラウザでのユーザログインに該当するBrowser Flowを関連付けます。

Authentication画面の `Bindings` タブをクリックします。

image::sso_binding1.png[sso_binding1]

Browser Flowのプルダウンリストから  `Stepup` を選択します。

image::sso_binding2.png[sso_binding2]

選択後、 `Save` をクリックします

image::sso_binding3.png[sso_binding3]

=== ステップアップ認証のための認証フローの設定その4
最後のRed Hat SSOの設定になります。
ここまでの設定で、Authenticationでは、ACRでなくLoA(Level of Authentication)を設定しています。

* LoAが1なら、ユーザとパスワード認証
* LoAが2なら、OTP認証

LoAは、数値で、ACRの文字列にマッピングすることで、アプリからの acr_values パラメーター(URLのクエリ等)でRH-SSOに要求できます。
なぜ、こんな面倒くさいことをしているかというと、Red Hat SSOは様々なプロトコルに対応しており、LoAで抽象化して、LoAとOIDCの実装であるACRと紐付けることで、異なる認証認可プロトコル(SAML等)にも対応できるようにしています。

今回は、以下のようにLoAとACRの文字列をマッピングします。

* LoAが1なら、ACRはfirst
* LoAが2なら、ACRはsecond

実際に、LoAとACRのマッピングを実施します。マッピングはレルム単位やアプリ単位で実施可能ですが、今回は、レルム単位で実施します。

`Realm Setting` -> `Login` タブをクリックします。

image::sso_acr1.png[sso_acr1]

以下の項目を入力し、 `+` をクリックします。

* LoA: fist
* ACR : 1

image::sso_acr2.png[sso_acr2]

画面の入力項目が追加されたら、以下の項目を入力し、 `save` をクリックします。

* LoA: second
* ACR : 2

image::sso_acr3.png[sso_acr3]

=== Quarkusアプリケーションでのアクセス



@@途中です。。



