[#server-setup]
Red Hat SSO のインストールが完了したので、Red Hat SSO における重要な概念である Realm (レルム) の説明と、ログイン画面によくある機能の例としてユーザー登録の設定を行います。


[#what-is-realm]
=== Realm (レルム) とは何か
Red Hat SSO の基本的な設定をする前に Realm (レルム) とは何かを説明します。

レルムとは、特定のグループ・アプリケーション・サービスに関するすべての設定やオプションのための論理的な名前空間です。
レルムでは一連のユーザー・アプリケーション・登録されたアイデンティティブローカー・クライアントなどのセキュリティメタデータを保護し管理します。

ユーザーは、Red Hat SSO の管理コンソール (Admin Console) において、特定のレルム内に作成することができます。
ロール (権限) はレルムレベルで定義することができ、これらのロールを特定のユーザーに割り当てるために、ユーザーロールマッピングを設定することもできます。
ユーザーは、レルムに所属しており、レルムにログインすることができます。
レルムは互いに隔離されており、自分が管理するユーザーのみを管理・認証することができます。

image::realm.png[Realm]

[#master-realm]
=== マスターレルム （Master Realm）
マスターレルムとは、Red Hat SSO の初期レルムを指しています。
これはレルムの階層構造の中で最も高いレベルです。このレルムの管理者アカウントは、Red Hat SSO のサーバーインスタンス上に作成された他のレルムを参照・管理する権限を持ちます。
初期管理者アカウントを定義するとき、マスターレルムにアカウントを作成します。管理コンソールへの最初のログインもマスターレルム経由になります。

組織内のユーザーとアプリケーションを管理するために、マスターレルムを使用しないことが推奨されています。
マスターレルムを使用するのは、システム内のレルムを作成し管理する最上位の管理者のみに限定してください。
このセキュリティモデルに従うと、偶発的な変更を防ぐことができ、ユーザーアカウントにタスクの実行に必要な権限のみを許可することができます。

マスターレルムを無効にし、新規作成したレルムごとに管理者アカウントを定義することも可能です。
各レルムには専用の管理コンソールがあり、ローカルアカウントでログインすることができます。


[#user-registration]
=== ユーザー登録
Red Hat SSO では、ログイン画面によくある機能の例としてユーザー登録機能を追加することができます。

Red Hat SSO の管理コンソールから `Demojs` レルムの `Login` タブをクリックします。

image::sso_login.png[Login]

`User Registration` を有効にし、`Save` をクリックします。

image::sso_login2.png[Login]

プライバシーモードで新しいブラウザセッションを開くか、別のブラウザを開いてください。Red Hat SSO には、アカウント管理画面があり、そこからアカウントを登録します。

* アカウント管理画面: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/realms/demojs/account

1. アカウント管理画面の右上の `Sing-in` をクリックすると、 ログイン画面が表示されます。
2. `register` をクリックし、適当にユーザ情報を入力してください。

これでユーザー登録を行い、登録したユーザーで Demojs レルムにログインすることができました。


[#email-integration]
=== メール連携の設定 (オプション)
本セクションの実施はオプションです。本ハンズオンを一通り実施完了し、時間が余ることを確認できてから実施してください。

Red Hat SSO では、よくある初回ログイン時に認証メールを送信することができます。

まずは、テストに使うだけのメールサーバーをセットアップしましょう。MailCatcher はシンプルな SMTP サーバーで、送られてきたメッセージをすべてキャッチして Web インターフェースに表示します。
MailCatcherを実行することで、テスト用に設定したすべてのメールを取得することができます。
メールサーバーはポート "1025" でセットアップされ、メッセージの送受信確認ための Web インターフェースはポート "8080" で設定します。

開発環境の画面に移動して、次のコマンドを実行して、テスト用メールサーバーを作成します。
画面の右側にあるワークベンチアイコンをクリックします。

image::crw_right_workbench.png[Workbench]

1.  `Login to OpenShift` をクリックします。
2.  `New Terminal` をクリックします。

New Terminalで開いたターミナルにおいて、以下のコマンドを実行します。

[source,bash,role="copypaste"]
----
oc new-app quay.io/sshaaf/mailcatcher --name=mailcatcher
oc expose svc/mailcatcher --port 8080
----

コマンドの説明

1. 最初のコマンドでメールキャッチャーサーバーをデプロイします
2. 2つ目のコマンドは、受信したメールを見るためのhttpエンドポイントを設定するために、8080番ポートを公開します。

デプロイが完了すると、OpenShiftのコンソールで次のように表示されます。

image::OpenShift_mailcatcherinstalled.png[Mailcatcher]

Red Hat SSO 側の管理画面で設定をします。
まず、管理者用メールアカウントを追加します。
SSO 管理コンソールにログインしていることを確認し、SSO 管理コンソールの右端にあるメニューをクリックします。

`Manage account` をクリックすると、管理者ユーザープロファイルが表示されます。

image::sso_adminprofile.png[Admin profile]

Personal Info画面が開いて、メールアドレスとFirst nameとLast nameを入力します。

* Email: `admin@mysso.com`
* First name:  適当でOK
* Last name: 適当でOK

完了したら、 `Save` ボタンを押して、`Back to Security Admin Console` に戻るをクリックします。

次に、左側メニューの `realm settings` をクリックし、 `Email` タブをクリックします。先程設定した内容を入力します。

* Host: `mailcatcher`
* Port: `1025`
* From: `admin@mysso.com`

image::sso_adminemailconfig.png[Realm Email config]

`Save` をクリックします。

では、早速テストしてみましょう。
`Test Connection` を押すと、設定がうまくいったかどうかが報告されます。
成功した場合、「[KEYCLOAK] - SMTP test message」などの件名で、メールが届きます。

OpenShiftコンソールの mailcatcher の右上のアイコンをクリックすると、メールが確認できます。

image::mailcatcher_ui.png[Email config]

これで、Red Hat SSO でのメールサーバーの設定は完了です。

では、次に Red Hat SSO の管理コンソールから `Login` タブに移動します。

image::sso_adminloginconfig.png[Realm Login settings]

以下を有効にします:

1. `User Registration` 新しいユーザーがSSOに登録可能にします。
2. `Verify Email` メールによるユーザーを確認を有効化します。

`Save` をクリックします。

それでは、この設定をテストしていきます。
プライバシーモードで新しいブラウザセッションを開くか、別のブラウザを開いてください。

* アカウント管理画面: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/realms/demojs/account

1. アカウント管理画面の右上の `Sing-in` をクリックすると、 ログイン画面が表示されます。
2. `register` をクリックし、適当にユーザ情報を入力してください。
3. 新しく作成されたユーザーを確認するためにメールが送信されるので、mailcatcherに送信されます。

ユーザ登録が完了すると、以下の画面が表示されます。

image::sso_adminemailverify.png[Realm Login settings]

mailcatcher にアクセスすると、新しい電子メールが届いているはずです。
メールに記載されているリンクをクリックし、新しいユーザーを確認します。これで、新しいユーザで管理コンソールにログインできるはずです。（確認メールのリンクをコピーして、ユーザ登録したブラウザ側で開いてください）

さて、これで Red Hat SSO サーバーとそのレルムの基本的な設定ができました。
次の章では、最初のアプリケーションをデプロイし、Red Hat SSO を用いてシングルサインオンを実現するように設定します。
