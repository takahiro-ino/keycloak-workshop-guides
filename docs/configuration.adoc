[#server-setup]
Red Hat SSO のインストールが完了したので、Red Hat SSO における重要な概念である Realm (レルム) の説明と、ログイン画面によくある機能の例としてユーザー登録の設定を行います。


[#what-is-realm]
=== Realm (レルム) とは何か
Red Hat SSO の基本的な設定をする前に Realm (レルム) とは何かを説明します。

レルムとは、特定のグループ・アプリケーション・サービスに関するすべての設定やオプションのための論理的な名前空間です。
レルムでは一連のユーザー・アプリケーション・登録されたアイデンティティブローカー・クライアントなどのセキュリティメタデータを保護し管理します。

ユーザーは、Red Hat SSO の管理コンソール (Admin Console) において、特定のレルム内に作成することができます。
ロール (権限) はレルムレベルで定義することができ、これらのロールを特定のユーザーに割り当てるために、ユーザーロールマッピングを設定することもできます。
ユーザーは、レルムに所属しており、レルムにログインすることができます。
レルムは互いに隔離されており、自分が管理するユーザーのみを管理・認証することができます。

image::realm.png[Realm]

[#master-realm]
=== マスターレルム （Master Realm）
マスターレルムとは、Red Hat SSO の初期レルムを指しています。
これはレルムの階層構造の中で最も高いレベルです。このレルムの管理者アカウントは、Red Hat SSO のサーバーインスタンス上に作成された他のレルムを参照・管理する権限を持ちます。
初期管理者アカウントを定義するとき、マスターレルムにアカウントを作成します。管理コンソールへの最初のログインもマスターレルム経由になります。

組織内のユーザーとアプリケーションを管理するために、マスターレルムを使用しないことが推奨されています。
マスターレルムを使用するのは、システム内のレルムを作成し管理する最上位の管理者のみに限定してください。
このセキュリティモデルに従うと、偶発的な変更を防ぐことができ、ユーザーアカウントにタスクの実行に必要な権限のみを許可することができます。

マスターレルムを無効にし、新規作成したレルムごとに管理者アカウントを定義することも可能です。
各レルムには専用の管理コンソールがあり、ローカルアカウントでログインすることができます。


[#user-registration]
=== ユーザー登録
Red Hat SSO では、ログイン画面によくある機能の例としてユーザー登録機能を追加することができます。

Red Hat SSO の管理コンソールから `Demojs` レルムの `Login` タブをクリックします。

image::sso_login.png[Login]

`User Registration` を有効にし、`Save` をクリックします。

image::sso_login2.png[Login2]

Red Hat SSO には、アカウント管理画面があり、そこからアカウントを登録します。

* アカウント管理画面: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/realms/demojs/account

アカウント管理画面の右上の `Sing-in` をクリックすると、 ログイン画面が表示されます。

image::sso_siginin.png[siginin]

`register` をクリックしてください。

image::sso_siginin2.png[siginin2]

ユーザ登録画面が表示されます。各項目を適当に入力してください。(メールアドレスはhoge@hogeのようにドメインが必要です)

image::sso_siginin3.png[siginin3]

これでユーザー登録を行い、登録したユーザーで Demojs レルムにログインすることができました。

image::sso_siginin4.png[siginin4]


[#config-OTP]
=== ワンタイムパスワード（OTP）の設定
Red Hat SSO では、ワンタイムパスワード（OTP）が利用できます。
具体的には、スマートフォンアプリのFreeOTPとGoogle Authenticatorが利用可能です。
以降の手順では、スマートフォンに、FreeOTPとGoogle Authenticatorが必要なため、お手持ちのスマートフォンにいずれかをインストールしておく必要があります。

ワンタイムパスワード（OTP）の設定を実施します。
さきほどのアカウント管理画面から、 `Personal Info` をクリックしてください。

image::sso_otp1.png[otp1]

Personal Info画面の左ペインから、 `Account Security` をクリックし、さらに `Signing In` をクリックし、
Signing In画面の `Set up Autehnticator Application` をクリックします。

image::sso_otp2.png[otp2]

[NOTE]
====
下記のページが表示された場合は、さきほど入力したユーザ名とパスワードを入力し、`Sing in` をクリックしてください。

image::sso_otp2-1.png[otp2-1]
====

以下のようにQRコードが画面に表示されます。お手持ちのスマートフォンのFreeOTPとGoogle Authenticatorから、QRコードをスキャンします。

image::sso_otp3.png[otp3]

以下は、FreeOTPでの操作となります。
FreeOTPを起動し、QRスキャンボタンを押します。

image::free_otp1.png[free_otp1, 400]

スマートフォンでRH-SSOの画面のQRコードをスキャンし、いくつかボタンを押すと、FreeOTPにレルム名(demojs)で登録されます。

image::free_otp2.png[free_otp2, 400]

スマートフォンのFreeOTPに登録されたレルム名(demojs)をクリックすると、ワンタイムパスワードが表示されます。

image::free_otp3.png[free_otp3, 400]

スマートフォンのFreeOTPで表示されたワンタイムパスワードとデバイス名(何でも良い)をRH-SSOの画面に入力し、 `Submit` をクリックし、登録します。

image::sso_otp4.png[otp4]

登録が完了すると、Personal Info画面でさきほど入力したデバイス名で、登録されていることがわかります。

image::sso_otp5.png[otp5]

さて、これで Red Hat SSO サーバーのユーザ登録とOTPの設定ができました。
次の章では、Quarkusアプリケーションをデプロイし、Red Hat SSO を用いてシングルサインオンを実現するように設定します。
